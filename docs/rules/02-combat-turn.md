# 02 - 战斗回合结构

> **核心规则**：战斗内不可变的回合结构，与数据记录的「回合边界」对齐。  
> **参考**：[Slay the Spire Wiki - Combat Mechanics](https://slay-the-spire.fandom.com/wiki/Combat_Mechanics)、[游民星空 - 战斗流程介绍](https://www.gamersky.com/handbook/201901/1148245_2.shtml)

---

## 回合三阶段

| 阶段 | 发生内容 | Mod 识别 |
|------|----------|----------|
| **回合开始** | 抽 5 张牌；获得 3 点能量（基础）；格挡归零 | `energy=3`（新回合）、`hand` 更新 |
| **出牌阶段** | 玩家可打牌、用药水 | `ready_for_command=true`，`play`/`end` 在 `available_commands` |
| **回合结束** | 剩余手牌丢弃；能量清零；怪物行动 | 玩家发送 `end` 后进入怪物回合 |

---

## 回合开始

- **抽牌**：原则上抽 5 张，可被遗物/牌改变（如静默蛇之戒指第一回合 +2）。
- **能量**：基础 3 点，可被遗物增加。
- **格挡**：回合开始时移除（除非 Barricade、Blur 等保留）。
- **手牌上限**：10 张，满时抽牌效果失效。

---

## 出牌阶段

- **打牌**：消耗对应能量，能量不足无法出牌。
- **药水**：任意时刻使用，不消耗能量。
- **牌去向**：打出后进入弃牌堆（除非 Retain、Exhaust 等）。

---

## 回合结束

- **手牌**：未打出的牌进入弃牌堆。
- **能量**：不累积到下回合。
- **怪物**：按意图行动。
- **循环**：怪物行动后进入下一回合开始。

---

## 牌堆机制

- **抽牌堆**：抽牌来源；空时，弃牌堆洗牌后变为抽牌堆。
- **弃牌堆**：打出/丢弃的牌；抽牌堆空时洗回。
- **消耗牌堆**：Exhaust 的牌，本战斗不再使用。

---

## 合法动作（Mod 协议）

| 命令 | 说明 |
|------|------|
| `play <hand_index> <target>` | 打出手牌，`target` 为目标索引（单体 0） |
| `end` | 结束回合 |

- `hand_index`：**Mod 协议为 1-based**，1=第一张牌，2=第二张牌。代码中 `hand` 为 0-based 索引，发送时需 `idx + 1`。
- **可打出条件**：能量足够（或费用 ≤0）**且** `is_playable=true`。进阶之灾等「不能打出」的牌 `is_playable=false`，必须排除。
